# بنية ومنطق نظام "حاسبني"

## مقدمة

يقدم هذا المستند شرحًا معماريًا مفصلاً لمنطق العمل (Business Logic) وبنية البيانات لنظام "حاسبني". تم تصميم النظام باتباع نهج قائم على الخدمات (Service-Oriented Architecture)، حيث تكون كل وحدة وظيفية مسؤولة عن جانب معين من إدارة الموظفين، مما يضمن قابلية الصيانة والتطوير. يعتمد النظام على Firebase/Firestore كخلفية للخدمة، مما يوفر قاعدة بيانات NoSQL مرنة وقوية.

---

## 1. خدمة إدارة الموظفين (`employee-actions.ts`)

هذه الخدمة هي حجر الأساس في النظام، حيث تدير جميع البيانات المتعلقة بالموظفين.

#### بنية البيانات (Data Model)
- **المجموعة (Collection):** `workers`
- **المستند (Document):** كل مستند يمثل موظفًا واحدًا، ويحتوي على الحقول التالية:
  - `id`: (string) - المعرّف الفريد للموظف.
  - `name`: (string) - اسم الموظف.
  - `jobTitle`: (string) - المسمى الوظيفي.
  - `contract`: (object) - يحتوي على تفاصيل العقد مثل `startDate`, `endDate`.
  - `salary`: (object) - يحتوي على تفاصيل الراتب مثل `basic`, `housing`, `transportation`.
  - `status`: (string) - حالة الموظف (`active` | `archived`).

#### الوظائف الأساسية (Core Functions)

- **`addEmployee(workerData)`**
  - **المنطق:** إنشاء مستند جديد في مجموعة `workers` بالبيانات المدخلة. يتم تعيين الحالة الافتراضية إلى `active`.
  - **المحفز (Trigger):** قيام المستخدم بملء وحفظ نموذج "إضافة موظف جديد".
  - **النتيجة:** يتم إنشاء سجل موظف جديد في قاعدة البيانات.

- **`updateEmployee(employeeId, updatedData)`**
  - **المنطق:** تحديث الحقول المحددة لمستند موظف موجود في مجموعة `workers`.
  - **المحفز:** قيام المستخدم بتعديل وحفظ بيانات موظف في نافذة "إدارة الموظفين".
  - **النتيجة:** يتم تحديث بيانات الموظف.

- **`archiveEmployee(employeeId)`**
  - **المنطق:** تغيير قيمة حقل `status` إلى `archived` بدلاً من حذف المستند. هذا يضمن الحفاظ على البيانات التاريخية للموظف لأغراض الأرشفة والمراجعة المستقبلية.
  - **المحفز:** الضغط على زر "أرشفة" لأحد الموظفين.
  - **النتيجة:** يتم إخفاء الموظف من القوائم النشطة مع الاحتفاظ بسجلاته.

---

## 2. خدمة الحضور والانصراف (`DayDetailsModal.tsx` and related logic)

تدير هذه الخدمة السجل اليومي لحضور الموظفين، وهي مصممة لتكون فعالة وسريعة الاستجابة.

#### بنية البيانات
- **المجموعة:** `attendance_{YYYY}_{MM}` (مثال: `attendance_2023_12`)
- **المستند:** كل مستند يمثل موظفًا واحدًا، ومعرّف المستند هو `worker.id`.
- **الحقول:** يحتوي كل مستند على كائن (Map) واحد اسمه `days`:
  ```json
  {
    "days": {
      "1": { "status": "present", "in": "09:00", "out": "18:30", "notes": "Completed project X" },
      "2": { "status": "absent", "notes": "Unjustified" },
      "3": { "status": "annual_leave", "notes": "Updated via leave request" }
    }
  }
  ```

#### الوظائف الأساسية

- **`handleStatusChange(day, status, details)`**
  - **المنطق:**
    1.  تحديد اسم المجموعة ديناميكيًا بناءً على الشهر والسنة (مثال: `attendance_2023_12`).
    2.  تحديد مستند الموظف باستخدام `worker.id`.
    3.  يتم استخدام تحديث الحقل المتداخل (dot notation) لتعديل بيانات اليوم المحدد مباشرة (`days.{day}`).
    4.  إذا لم يكن المستند موجودًا، يتم إنشاؤه أولاً ثم تحديثه.
  - **المحفز:** تفاعل المستخدم مع نافذة "تفاصيل اليوم" واختيار حالة (حاضر، غائب، مرضية).
  - **النتيجة:** يتم تسجيل أو تحديث حالة حضور الموظف لليوم المحدد فورًا.

---

## 3. خدمة إدارة الإجازات (`leave.ts`)

تقوم هذه الخدمة بأتمتة دورة حياة طلبات الإجازة، من التقديم إلى التكامل مع سجل الحضور.

#### بنية البيانات
- **المجموعة:** `leave-requests`
- **المستند:** كل مستند يمثل طلب إجازة واحد، ويحتوي على:
  - `employeeId`, `employeeName`: (string) - معرّف واسم الموظف.
  - `startDate`, `endDate`: (date) - فترة الإجازة.
  - `leaveType`: (string) - نوع الإجازة (`annual` | `sick`).
  - `status`: (string) - حالة الطلب (`pending` | `approved` | `rejected`).
  - `reason`: (string) - سبب الإجازة.

#### الوظائف الأساسية

- **`updateLeaveRequestStatus(requestId, newStatus)`**
  - **المنطق:**
    1.  تحديث حقل `status` لمستند طلب الإجازة المحدد.
    2.  **منطق التكامل التلقائي:** إذا كانت الحالة الجديدة `approved`، يتم تشغيل منطق إضافي:
        - يقوم النظام بالمرور على كل يوم ضمن نطاق `startDate` و `endDate`.
        - لكل يوم، يتم استدعاء منطق خدمة الحضور (`handleStatusChange`) لتحديث حالة اليوم تلقائيًا إلى `annual_leave` أو `sick_leave`.
        - يتم إضافة ملاحظة تلقائية مثل "تم التحديث عبر طلب إجازة معتمد".
  - **المحفز:** قيام المدير بالموافقة على أو رفض طلب إجازة.
  - **النتيجة:** يتم تحديث حالة الطلب، والأهم من ذلك، يتم تحديث سجل حضور الموظف تلقائيًا دون أي تدخل يدوي.

---

## 4. خدمة معالجة الرواتب (Payroll Engine)

هذا هو المحرك الحسابي للنظام، وهو يربط جميع الخدمات معًا لتوليد كشوف المرتبات.

#### بنية البيانات
- **المجموعة:** `payrolls_{YYYY}_{MM}` (مثال: `payrolls_2023_12`)
- **المستند:** كل مستند يمثل كشف راتب لموظف واحد، ومعرّفه هو `worker.id`.
- **الحقول:**
  - `payrollDetails`: (object) - يحتوي على جميع مكونات الراتب المحسوبة: `baseSalary`, `allowances`, `deductions`, `overtimePay`, `netSalary`.
  - `generationDate`: (timestamp) - تاريخ إنشاء الكشف.

#### الوظائف الأساسية

- **`generatePayrollForMonth(year, month)`**
  - **المنطق:** هذه عملية مجمّعة (Batch Process) تقوم بالتالي لكل موظف `active`:
    1.  **جلب البيانات:** تجلب بيانات الموظف (من `workers`) وبيانات الحضور للشهر المحدد (من `attendance_{YYYY}_{MM}`).
    2.  **حساب الخصومات:** تمر على سجل الحضور وتحسب إجمالي أيام الغياب (`absent`). يتم حساب قيمة الخصم كـ `(Total Salary / 30) * غياب الأيام`.
    3.  **حساب العمل الإضافي:** تمر على سجل الحضور. لكل يوم `present`، تقارن `outTime - inTime` بساعات العمل القياسية (مثلاً، 8 ساعات). أي زيادة تعتبر عملاً إضافياً ويتم حساب تكلفتها بناءً على السياسة المتبعة (مثلاً، `الأجر بالساعة * 1.5`).
    4.  **حساب صافي الراتب:** المعادلة النهائية هي: `صافي الراتب = (الراتب الأساسي + البدلات) - الخصومات + أجر العمل الإضافي - (السلف + الجزاءات)`.
    5.  **تخزين النتائج:** يتم حفظ الكشف النهائي في مستند خاص بالموظف ضمن مجموعة `payrolls_{YYYY}_{MM}`.
  - **المحفز:** قيام المستخدم بالضغط على زر "معالجة الرواتب" للشهر المحدد.
  - **النتيجة:** يتم إنشاء سجلات رواتب دقيقة ومفصلة لجميع الموظفين النشطين، جاهزة للمراجعة والدفع.

---

## الخلاصة المعمارية

إن فصل المنطق إلى خدمات متخصصة مع بنية بيانات واضحة يسمح للنظام بالعمل بكفاءة. يكمن مفتاح قوة النظام في **التكامل التلقائي** بين الخدمات: **تؤثر الإجازات المعتمدة على الحضور، والحضور يؤثر مباشرة على الرواتب**. هذا التسلسل الآلي يقلل من الأخطاء البشرية بشكل كبير ويوفر الوقت والجهد للإدارة.
